{% extends 'main/layout.html' %}

{% load static %}

{% block content %}
    <div class="container">
        <div class="intro">
            <div class="intro-button" id="intro-trigger">Why?</div>
            <div class="intro-body intro-body-hidden" id="intro-box">
                Why yet another job board? <br>
                üèÉ The fastest (pages under 100KB) <br>
                üî™ No ads / pinned jobs <br>
                üèπ Tools for application track keeping <br>
                üíÖ Clean UI/UX <br>
                üí∞ Opinionated listings (must include salary)
            </div>
        </div>
        <div class="container-content">
            <div class="categories">
                <div class="categories-single"><a href="#frontend">Frontend</a></div>
                <div class="categories-single"><a href="#backend">Backend</a></div>
                <div class="categories-single"><a href="#fullstack">Fullstack</a></div>
                <div class="categories-single"><a href="#devops">Devops</a></div>
                <div class="categories-single"><a href="#mobile">Mobile</a></div>
            </div>

            <hr>

            <div class="listings">
                {% csrf_token %}
                {% for category in categories %}
                    <h2 id="{{ category|lower }}">{{ category }} jobs</h2>
                     {% for listing in category.listing_set.all %}
                        {% if listing.confirmed %}
                            <div class="listings-entry">
                                <div class="listings-entry-detail">
                                    <div class="listings-entry-detail-info">
                                        <a class="listings-entry-detail-info-title"  href="{% url 'main:detail' listing.id %}" data-id="{{ listing.id }}">
                                            <strong>{{ listing.role_title }}</strong>
                                            <span class="muted">at</span>
                                            <span class="listings-entry-detail-info-title-company">{{ listing.company_name }}</span>
                                        </a>
                                        <div class="listings-entry-detail-info-tags">
                                            {% for tag in listing.tag_set.all %}
                                                <div class="listings-entry-detail-info-tags-single">{{ tag }}</div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <div class="listings-entry-control">
                                    <div class="listings-entry-control-check" title="Dim out jobs you have applied" data-id="{{ listing.id }}">&#9702;</div>
                                </div>
                            </div>
                        {% endif %}
                    {% empty %}
                        <div class="empty">No job listings exist in this category.</div>
                    {% endfor %}
                {% empty %}
                    <div class="empty">No job listings exist :(</div>
                {% endfor %}
            </div>

            <a href="{% url 'main:create' %}" class="post">
                Interested in seeing your job listing here? Click here.
            </a>

        </div>

        <footer>
            <p>Avocado Jobs. Contact <a href="mailto:hi@avocadojobs.com">here</a>.</p>
        </footer>
    </div>

    <script src="{% static '/main/superagent.min.js' %}"></script>
    <script>
        (function () {
            var listingIdsStore = [];

            // initial dimming of all listings that are in the listingIdsStore
            function renderDimmedElems() {
                var listingLinkElems = document.getElementsByClassName('listings-entry-detail-info-title');
                var i = 0;
                for (i = 0; i < listingLinkElems.length; i++) {
                    listingIdsStore.forEach(function (singleListingId) {
                        if (singleListingId === listingLinkElems[i].dataset.id) {
                            listingLinkElems[i].style.opacity = 0.2;
                        }
                    });
                }
            };

            // fetch listings applications ids for this user from the app
            function getApplicationListings() {
                superagent.get('/applications/')
                    .type('application/json')
                    .end(function (err, res) {
                        if (err) {
                            console.log('Failed to get applications. Error:', err);
                        }
                        listingIdsStore = res.body.applications;
                        renderDimmedElems();
                    });
            };

            // check if user is authenticated
            function isAuthed() {
                if (document.getElementById('user-authed')) {
                    return true;
                } else {
                    return false;
                }
            }

            // get csrf from the html
            function getCsrf() {
                var inputElems = document.querySelectorAll('input');
                var csrfToken = '';
                for (i = 0; i < inputElems.length; ++i) {
                    if (inputElems[i].name === 'csrfmiddlewaretoken') {
                        csrfToken = inputElems[i].value;
                        break;
                    }
                }
                return csrfToken;
            };

            // remove application listing, aka make opacity 100%
            function removeApplicationListing(listingIdForDeletion, idIndex) {
                if (isAuthed()) {
                    var csrfToken = getCsrf();
                    superagent.post('/applications/' + listingIdForDeletion + '/delete/')
                        .set('X-CSRFToken', csrfToken)
                        .end(function (err, res) {
                            if (err) {
                                console.log('Failed at deleting application. Error:', err);
                            } else {
                                document.querySelectorAll('a[data-id="' + listingIdForDeletion + '"')[0].style.opacity = 1;
                                listingIdsStore.splice(idIndex, 1);
                            }
                        });
                } else {
                    document.querySelectorAll('a[data-id="' + listingIdForDeletion + '"')[0].style.opacity = 1;
                    listingIdsStore.splice(idIndex, 1);
                }
            }

            // add new listing as application, aka opacity = 20%
            function checkNewApplication(listingId) {
                if (isAuthed()) {
                    var csrfToken = getCsrf();
                    superagent.post('/applications/')
                        .send({
                            'listing_id': listingId,
                        })
                        .set('X-CSRFToken', csrfToken)
                        .end(function superagentEndCallback(err, res) {
                            if (err) {
                                console.log('Failed to create new application listing. Error:', err);
                            }
                            document.querySelectorAll('a[data-id="' + listingId + '"')[0].style.opacity = 0.2;
                            listingIdsStore.push(listingId);
                        });
                } else {
                    document.querySelectorAll('a[data-id="' + listingId + '"')[0].style.opacity = 0.2;
                    listingIdsStore.push(listingId);
                }
            }

            // function to run when a circle is clicked
            function controlCheckListener(event) {
                var id = event.target.dataset.id;
                var idIndex = listingIdsStore.indexOf(id);
                if (idIndex > -1) {
                    removeApplicationListing(id, idIndex);
                } else {
                    checkNewApplication(id);
                }
                renderDimmedElems();
            }

            // add event listeners to bullet icons
            var controlCheckElems = document.getElementsByClassName('listings-entry-control-check');
            var i = 0;
            for (i = 0; i < controlCheckElems.length; i++) {
                controlCheckElems[i].addEventListener('click', controlCheckListener);
            }

            // init page scripts
            if (isAuthed()) {
                getApplicationListings();
            }

            // add event listener for why box
            document.getElementById('intro-trigger').addEventListener('click', function (event) {
                document.getElementById('intro-box').classList.toggle('intro-body-hidden');
            });
        })()
    </script>
{% endblock %}
