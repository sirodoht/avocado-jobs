{% extends 'main/layout.html' %}

{% load static %}

{% block content %}
    <div class="container-content-header">
        <div class="container-content-header-content">
            <h1>Keep track of your job applications</h1>
        </div>
    </div>

    <div class="container-content-body">
        <div class="listings">
            {% csrf_token %}
            {% for application in applications_list %}
                <div class="listings-entry">
                    <div class="listings-entry-detail">
                        <div class="listings-entry-detail-info">
                            <a class="listings-entry-detail-info-title" href="{{ application.url }">
                                <strong>{{ application.role_title }}</strong>
                                <span class="muted">at</span>
                                <span class="listings-entry-detail-info-title-company">{{ application.company_name }}</span>
                            </a>
                            <div class="listings-entry-detail-info-stage" data-id="{{ application.id }}">
                                <select name="stage" class="submission-stage">
                                    <option {% if application.stage == 'INITIAL' %}selected{% endif %} value="initial">No initial response yet</option>
                                    <option {% if application.stage == 'NEED' %}selected{% endif %} value="need">I need to respond</option>
                                    <option {% if application.stage == 'AWAIT' %}selected{% endif %} value="await">Awaiting response</option>
                                    <option {% if application.stage == 'SCHEDULED' %}selected{% endif %} value="scheduled">Interview scheduled</option>
                                    <option {% if application.stage == 'OFFER' %}selected{% endif %} value="offer">Got offer</option>
                                    <option {% if application.stage == 'DECLINED' %}selected{% endif %} value="declined">Declined</option>
                                    <option {% if application.stage == 'REJECTED' %}selected{% endif %} value="rejected">Got Rejected</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="listings-entry-control">
                        <div class="listings-entry-control-rm" title="Remove listing from applications" data-id="{{ application.id }}" onclick="removeApplication(event)">x</div>
                    </div>
                </div>
            {% empty %}
                {% if user.is_authenticated %}
                    <div class="empty">
                        There are no job applications.
                        <br>
                        You can add a new one by click clicking the button at the top.
                    </div>
                {% endif %}
            {% endfor %}
        </div>
        {% if not user.is_authenticated %}
            <div class="reset">
                <div class="reset-content" title="Reset demo data to their initial values" onclick="resetApplications()">Reset demo data</div>
            </div>
        {% endif %}
    </div>

    {% if user.is_authenticated %}
        <script src="{% static '/main/superagent.min.js' %}"></script>
        <script>
            // get csrf from the html
            function getCsrf() {
                var inputElems = document.querySelectorAll('input');
                var csrfToken = '';
                for (i = 0; i < inputElems.length; ++i) {
                    if (inputElems[i].name === 'csrfmiddlewaretoken') {
                        csrfToken = inputElems[i].value;
                        break;
                    }
                }
                return csrfToken;
            };

            // remove application from user's
            function removeApplication(event) {
                event.preventDefault();

                if (!window.confirm('Are you sure you want to remove listing application?')) {
                    return;
                }

                var inputElems = document.querySelectorAll('input');
                var csrfToken = getCsrf();

                var idForDeletion = event.target.dataset.id;
                superagent.post('/applications/' + idForDeletion + '/delete/')
                    .set('X-CSRFToken', csrfToken)
                    .end(function (err, res) {
                        if (err) {
                            console.log('Error at deletion:', err);
                        } else {
                            document.location.reload();
                        }
                    });
            }

            function changeStageListen(event) {
                var csrfToken = getCsrf();
                var listingId = event.target.parentElement.dataset.id;
                var newStage = event.target.value;
                superagent.patch('/applications/')
                    .send({
                        'listing_id': listingId,
                        'stage': newStage,
                    })
                    .set('X-CSRFToken', csrfToken)
                    .end(function superagentEndCallback(err, res) {
                        if (err) {
                            console.log('Failed to update application stage. Error:', err);
                        }
                    });
            }

            function initApplicationStage() {
                // add event listeners to select elems
                var stageSelectElems = document.getElementsByClassName('submission-stage');
                var i = 0;
                for (i = 0; i < stageSelectElems.length; i++) {
                    stageSelectElems[i].addEventListener('change', changeStageListen);
                }
            }
            initApplicationStage()
        </script>
    {% else %}
        <script>
            var demoData = [
                {
                    id: 1,
                    role: 'Frontend Developer',
                    company: 'Avocado Jobs',
                    stage: 'scheduled',
                },
                {
                    id: 2,
                    role: 'Backend Engineeer',
                    company: 'Acme Corporation',
                    stage: 'need',
                },
                {
                    id: 3,
                    role: 'Security Engineer',
                    company: 'E Corp',
                    stage: 'initial',
                },
            ];

            function getData() {
                var data = demoData;
                if (window.localStorage.avocadoLocalData) {
                    data = JSON.parse(window.localStorage.avocadoLocalData);
                } else {
                    window.localStorage.avocadoLocalData = JSON.stringify(demoData);
                }

                checkEmpty();

                return data;
            }

            function setNewData(newData) {
                window.localStorage.avocadoLocalData = JSON.stringify(newData);
                checkEmpty();
            }

            function checkEmpty() {
                var length = JSON.parse(window.localStorage.avocadoLocalData).length;
                if (window.localStorage.avocadoLocalData && length === 0) {
                    var listingsElem = document.getElementsByClassName('listings')[0];
                    var listingsEmptyElem = document.createElement('div');
                    listingsEmptyElem.classList.add('empty');
                    listingsElem.appendChild(listingsEmptyElem);
                    listingsEmptyElem.appendChild(document.createTextNode('There are no job applications.'));
                    listingsEmptyElem.appendChild(document.createElement('br'));
                    listingsEmptyElem.appendChild(document.createTextNode('You can add a new one by click clicking the button at the top.'));
                }
            }

            function resetApplications() {
                window.localStorage.avocadoLocalData = JSON.stringify(demoData);
                window.location.reload();
            }

            function removeApplication(event) {
                event.preventDefault();
                if (!window.confirm('Are you sure you want to remove this application?')) {
                    return;
                }

                var idForDeletion = parseInt(event.target.dataset.id);
                var newData = getData();
                newData.forEach(function findRecord(record, index) {
                    if (record.id === idForDeletion) {
                        newData.splice(index, 1);
                        event.target.parentNode.parentNode.remove();
                        setNewData(newData);
                    }
                })
            }

            function changeStageListen(event) {
                var applicationId = parseInt(event.target.parentElement.dataset.id);
                var newStage = event.target.value;
                var newData = getData();
                newData.forEach(function findRecord(record, index) {
                    if (record.id === applicationId) {
                        record.stage = newStage;
                        setNewData(newData);
                    }
                })
            }

            // I don't like this code, I need to use a lib, which means THOUSANDS of LOC boilerplate :(
            function renderData(demoData) {
                demoData.forEach(function renderRecord(applicationRecord) {
                    var listingsElem = document.getElementsByClassName('listings')[0];
                    var listingsEntryElem = document.createElement('div');
                    listingsEntryElem.classList.add('listings-entry');
                    listingsElem.appendChild(listingsEntryElem);

                    var listingsEntryDetailElem = document.createElement('div');
                    listingsEntryDetailElem.classList.add('listings-entry-detail');
                    listingsEntryElem.appendChild(listingsEntryDetailElem);

                    var listingsEntryDetailInfoElem = document.createElement('div');
                    listingsEntryDetailInfoElem.classList.add('listings-entry-detail-info');
                    listingsEntryDetailElem.appendChild(listingsEntryDetailInfoElem);

                    var listingsEntryDetailInfoTitleElem = document.createElement('a');
                    listingsEntryDetailInfoTitleElem.classList.add('listings-entry-detail-info-title');
                    listingsEntryDetailInfoTitleElem.href = '#';
                    listingsEntryDetailInfoElem.appendChild(listingsEntryDetailInfoTitleElem);

                    var listingsEntryDetailInfoTitleStrongElem = document.createElement('strong');
                    listingsEntryDetailInfoTitleStrongElem.appendChild(document.createTextNode(applicationRecord.role));
                    listingsEntryDetailInfoTitleElem.appendChild(listingsEntryDetailInfoTitleStrongElem);

                    var listingsEntryDetailInfoTitleSpanElem = document.createElement('span');
                    listingsEntryDetailInfoTitleSpanElem.classList.add('muted');
                    listingsEntryDetailInfoTitleSpanElem.appendChild(document.createTextNode(' at '));
                    listingsEntryDetailInfoTitleElem.appendChild(listingsEntryDetailInfoTitleSpanElem);

                    var listingsEntryDetailInfoTitleCompanyElem = document.createElement('span');
                    listingsEntryDetailInfoTitleCompanyElem.classList.add('listings-entry-detail-info-title-company');
                    listingsEntryDetailInfoTitleCompanyElem.appendChild(document.createTextNode(applicationRecord.company));
                    listingsEntryDetailInfoTitleElem.appendChild(listingsEntryDetailInfoTitleCompanyElem);

                    var listingsEntryDetailInfoStageElem = document.createElement('div');
                    listingsEntryDetailInfoStageElem.classList.add('listings-entry-detail-info-stage');
                    listingsEntryDetailInfoStageElem.dataset.id = applicationRecord.id;
                    listingsEntryDetailInfoElem.appendChild(listingsEntryDetailInfoStageElem);

                    var listingsEntryDetailInfoStageSelectElem = document.createElement('select');
                    listingsEntryDetailInfoStageSelectElem.classList.add('submission-stage');
                    listingsEntryDetailInfoStageSelectElem.name = 'stage';
                    listingsEntryDetailInfoStageSelectElem.onchange = changeStageListen;
                    listingsEntryDetailInfoStageElem.appendChild(listingsEntryDetailInfoStageSelectElem);

                    var selectOptions = [
                        {
                            value: 'initial',
                            text: 'No initial response yet',
                        },
                        {
                            value: 'need',
                            text: 'I need to response',
                        },
                        {
                            value: 'await',
                            text: 'Awaiting response',
                        },
                        {
                            value: 'scheduled',
                            text: 'Interview schedule',
                        },
                        {
                            value: 'offer',
                            text: 'Got offer',
                        },
                        {
                            value: 'declined',
                            text: 'Declined',
                        },
                        {
                            value: 'rejected',
                            text: 'Got rejected',
                        },
                    ]

                    selectOptions.forEach(function renderSelectOption(optionItem) {
                        var listingsEntryDetailInfoStageSelectOptionElem = document.createElement('option');
                        listingsEntryDetailInfoStageSelectOptionElem.value = optionItem.value;
                        if (applicationRecord.stage === optionItem.value) {
                            listingsEntryDetailInfoStageSelectOptionElem.selected = true;
                        }
                        listingsEntryDetailInfoStageSelectOptionElem.appendChild(document.createTextNode(optionItem.text));
                        listingsEntryDetailInfoStageSelectElem.appendChild(listingsEntryDetailInfoStageSelectOptionElem);
                    })

                    var listingsEntryControlElem = document.createElement('div');
                    listingsEntryControlElem.classList.add('listings-entry-control');
                    listingsEntryElem.appendChild(listingsEntryControlElem);

                    var listingsEntryControlRmElem = document.createElement('div');
                    listingsEntryControlRmElem.classList.add('listings-entry-control-rm');
                    listingsEntryControlRmElem.title = 'Remove listing from applications';
                    listingsEntryControlRmElem.dataset.id = applicationRecord.id;
                    listingsEntryControlRmElem.onclick = removeApplication;
                    listingsEntryControlRmElem.appendChild(document.createTextNode('x'));
                    listingsEntryControlElem.appendChild(listingsEntryControlRmElem);

                });

            }

            renderData(getData());
        </script>
    {% endif %}
{% endblock %}
